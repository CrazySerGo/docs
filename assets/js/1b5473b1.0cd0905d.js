"use strict";(self.webpackChunkdocs_oasis_dev=self.webpackChunkdocs_oasis_dev||[]).push([[1658],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return m}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var d=a.createContext({}),l=function(e){var n=a.useContext(d),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=l(e.components);return a.createElement(d.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,d=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=l(t),m=r,g=c["".concat(d,".").concat(m)]||c[m]||u[m]||i;return t?a.createElement(g,o(o({ref:n},p),{},{components:t})):a.createElement(g,o({ref:n},p))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=c;var s={};for(var d in n)hasOwnProperty.call(n,d)&&(s[d]=n[d]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<i;l++)o[l]=t[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},3781:function(e,n,t){t.r(n),t.d(n,{assets:function(){return p},contentTitle:function(){return d},default:function(){return m},frontMatter:function(){return s},metadata:function(){return l},toc:function(){return u}});var a=t(7462),r=t(3366),i=(t(7294),t(3905)),o=["components"],s={},d="Handling Network Upgrades",l={unversionedId:"run-a-node/maintenance-guides/handling-network-upgrades",id:"run-a-node/maintenance-guides/handling-network-upgrades",title:"Handling Network Upgrades",description:"Following this guide when there is no network upgrade will result in you losing your place on the current network.",source:"@site/docs/general/run-a-node/maintenance-guides/handling-network-upgrades.md",sourceDirName:"run-a-node/maintenance-guides",slug:"/run-a-node/maintenance-guides/handling-network-upgrades",permalink:"/general/run-a-node/maintenance-guides/handling-network-upgrades",editUrl:"https://github.com/oasisprotocol/docs.oasis.dev/edit/main/docs/general/run-a-node/maintenance-guides/handling-network-upgrades.md",tags:[],version:"current",lastUpdatedAt:1652342868,formattedLastUpdatedAt:"5/12/2022",frontMatter:{},sidebar:"docs",previous:{title:"Wiping Node State",permalink:"/general/run-a-node/maintenance-guides/wiping-node-state"},next:{title:"Adding or Removing Nodes",permalink:"/general/run-a-node/maintenance-guides/adding-or-removing-nodes"}},p={},u=[{value:"Stop the node at specific epoch",id:"stop-the-node-at-specific-epoch",level:2},{value:"Manually exporting network state",id:"manually-exporting-network-state",level:2},{value:"Patch Dumped State",id:"patch-dumped-state",level:2},{value:"Download and Verify the Provided Genesis File",id:"verify-genesis",level:2},{value:"Example diff for Mainnet Beta to Mainnet network upgrade",id:"example-diff-for-mainnet-beta-to-mainnet-network-upgrade",level:3},{value:"Stop Your Node",id:"stop-your-node",level:2},{value:"Wipe State",id:"wipe-state",level:2},{value:"Update Configuration",id:"update-configuration",level:2},{value:"Upgrade Oasis Node",id:"upgrade-oasis-node",level:2},{value:"Start Your Node",id:"start-your-node",level:2},{value:"Clean Up",id:"clean-up",level:2}],c={toc:u};function m(e){var n=e.components,t=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"handling-network-upgrades"},"Handling Network Upgrades"),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Following this guide when there is no network upgrade will result in you losing your place on the current network."))),(0,i.kt)("p",null,"The following guide should be used when the network has agreed to do a software upgrade."),(0,i.kt)("h2",{id:"stop-the-node-at-specific-epoch"},"Stop the node at specific epoch"),(0,i.kt)("p",null,"Before an upgrade we will update the ",(0,i.kt)("a",{parentName:"p",href:"/general/run-a-node/upgrade-log"},"Upgrade Log")," to specify the epoch height at which the upgrade will take place. Additionally, an upgrade descriptor will be provided which can be used to instruct the node to shutdown and export state at the start of the upgrade epoch."),(0,i.kt)("p",null,"To submit the provided upgrade descriptor use the following command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"oasis-node control upgrade-binary \\\n -a unix:/serverdir/node/internal.sock \\\n <PATH-TO-UPGRADE-DESCRIPTOR.json>\n")),(0,i.kt)("p",null,'To verify that the upgrade descriptor has been received, grep your node\'s logs for "received upgrade descriptor" message, e.g.:'),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},'{"caller":"upgrade.go:60","epoch":5102,"level":"info","module":"upgrade","msg":"received upgrade descriptor, scheduling shutdown","name":"testnet-upgrade-2021-03-24","ts":"2021-03-24T09:56:52.944552808Z"}')),(0,i.kt)("p",null,"If for any reason you would need to cancel a scheduled pending upgrade, use the ",(0,i.kt)("inlineCode",{parentName:"p"},"cancel-upgrade")," command."),(0,i.kt)("p",null,"Node reaching the upgrade epoch will automatically export network state to a genesis file under the following path:",(0,i.kt)("inlineCode",{parentName:"p"},"exports/genesis-<CHAIN-ID>-at-<DUMP-BLOCK-HEIGHT>.json"),"."),(0,i.kt)("h2",{id:"manually-exporting-network-state"},"Manually exporting network state"),(0,i.kt)("p",null,"To dump the state of the network to a genesis file, run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"oasis-node genesis dump \\\n  -a unix:/serverdir/node/internal.sock \\\n  --genesis.file /serverdir/etc/genesis_dump.json \\\n  --height <HEIGHT-TO-DUMP>\n")),(0,i.kt)("p",null,"replacing ",(0,i.kt)("inlineCode",{parentName:"p"},"<HEIGHT-TO-DUMP>")," with the block height we specified."),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You can only run the following command ",(0,i.kt)("em",{parentName:"p"},"after")," the ",(0,i.kt)("inlineCode",{parentName:"p"},"<HEIGHT-TO-DUMP>")," block height has been reached on the network."),(0,i.kt)("p",{parentName:"div"},"To see the network's current height, run:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"oasis-node control status -a unix:/serverdir/node/internal.sock\n")),(0,i.kt)("p",{parentName:"div"},"and observe the value of the ",(0,i.kt)("inlineCode",{parentName:"p"},"consensus.latest_height")," key."))),(0,i.kt)("h2",{id:"patch-dumped-state"},"Patch Dumped State"),(0,i.kt)("p",null,"At the moment, we don't provide state patches."),(0,i.kt)("p",null,"However, for certain upgrades we use the ",(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("inlineCode",{parentName:"strong"},"oasis-node debug fix-genesis"))," CLI command to automatically migrate/update some parts of the genesis file."),(0,i.kt)("p",null,"Other parts are updated manually, as described in each upgrade's Proposed State Changes section (e.g. ",(0,i.kt)("a",{parentName:"p",href:"/general/mainnet/previous-upgrades/cobalt-upgrade#proposed-state-changes"},"Cobalt upgrade's Proposed State Changes"),")."),(0,i.kt)("h2",{id:"verify-genesis"},"Download and Verify the Provided Genesis File"),(0,i.kt)("p",null,"Download the new genesis file linked in the ",(0,i.kt)("a",{parentName:"p",href:"/general/oasis-network/network-parameters"},"Network Parameters")," and save it as ",(0,i.kt)("inlineCode",{parentName:"p"},"/serverdir/etc/genesis.json"),"."),(0,i.kt)("p",null,"Then compare the dumped state with the downloaded genesis file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"diff --unified=3 genesis_dump.json genesis.json\n")),(0,i.kt)("h3",{id:"example-diff-for-mainnet-beta-to-mainnet-network-upgrade"},"Example diff for Mainnet Beta to Mainnet network upgrade"),(0,i.kt)("p",null,"Let's assume that the above ",(0,i.kt)("inlineCode",{parentName:"p"},"diff")," command returns:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-diff"},'--- genesis_dump.json    2020-11-16 17:49:46.864554271 +0100\n+++ genesis.json    2020-11-16 17:49:40.353496022 +0100\n@@ -1,7 +1,7 @@\n {\n   "height": 702000,\n-  "genesis_time": "2020-11-18T13:38:00Z",\n-  "chain_id": "mainnet-beta-2020-10-01-1601568000",\n+  "genesis_time": "2020-11-18T16:00:00Z",\n+  "chain_id": "oasis-1",\n   "epochtime": {\n     "params": {\n       "interval": 600\n@@ -2506,1563 +2506,1779 @@\n       "debonding_interval": 336,\n       "reward_schedule": [\n         {\n-          "until": 3696,\n-          "scale": "1595"\n+          "until": 4842,\n+          "scale": "2081"\n         },\n         {\n-          "until": 3720,\n-          "scale": "1594"\n+          "until": 4866,\n+          "scale": "2080"\n         },\n\n        ... trimmed ...\n\n         {\n-          "until": 35712,\n+          "until": 36882,\n           "scale": "2"\n         },\n         {\n-          "until": 35760,\n+          "until": 36930,\n           "scale": "1"\n         }\n       ],\n@@ -4087,7 +4303,6 @@\n         "transfer": 1000\n       },\n       "min_delegation": "100000000000",\n-      "disable_transfers": true,\n       "fee_split_weight_propose": "2",\n       "fee_split_weight_vote": "1",\n       "fee_split_weight_next_propose": "1",\n@@ -4097,7 +4312,7 @@\n     "token_symbol": "ROSE",\n     "token_value_exponent": 9,\n     "total_supply": "10000000000000000000",\n-    "common_pool": "1835039672187348312",\n+    "common_pool": "2285039672187348312",\n     "last_block_fees": "0",\n     "ledger": {\n       "oasis1qp0l8r2s3076n4xrq8av0uuqegj7z9kq55gu5exy": {\n@@ -6419,7 +6634,7 @@\n       },\n       "oasis1qrad7s7nqm4gvyzr8yt2rdk0ref489rn3vn400d6": {\n         "general": {\n-          "balance": "1633038701000000000"\n+          "balance": "1183038701000000000"\n         },\n         "escrow": {\n           "active": {\n@@ -9862,6 +10077,8 @@\n       }\n     }\n   },\n-  "halt_epoch": 1440,\n-  "extra_data": null\n+  "halt_epoch": 9940,\n+  "extra_data": {\n+    "quote": "UXVpcyBjdXN0b2RpZXQgaXBzb3MgY3VzdG9kZXM/IFtzdWJtaXR0ZWQgYnkgT2FzaXMgQ29tbXVuaXR5IE1lbWJlciBEYW5peWFyIEJvcmFuZ2F6aXlldl0="\n+  }\n }\n')),(0,i.kt)("p",null,"We can observe that the provided genesis file mostly updates some particular network parameters. In addition, some ROSE tokens were transferred from an account to the Common Pool. All other things remained unchanged."),(0,i.kt)("p",null,"Let's break down the diff and explain what has changed."),(0,i.kt)("p",null,"The following genesis file fields will always change on a network upgrade:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"chain_id"),": A unique ID of the network."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"genesis_time"),": Time from which the genesis file is valid."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"halt_epoch"),": The epoch when the node will stop functioning. We set this to intentionally force an upgrade.")),(0,i.kt)("p",null,"The following fields were a particular change in this upgrade:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"staking.params.reward_schedule"),": This field describes the staking reward model. It was changed to start at 20% (annualized) and range from 20% to 2% over the first 4 years of the network. For more details, see the updated ",(0,i.kt)("a",{parentName:"li",href:"/oasis-network-primer/token-metrics-and-distribution"},"Token Metrics and Distribution")," doc."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"staking.params.disable_transfers"),": This field was removed to enable token transfers."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"staking.common_pool"),": This field represents the Common Pool. Its balance was increased by 450M ROSE to fund increased staking rewards."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"staking.ledger.oasis1qrad7s7nqm4gvyzr8yt2rdk0ref489rn3vn400d6"),": This field corresponds to the Community and Ecosystem Wallet. Its ",(0,i.kt)("inlineCode",{parentName:"li"},"general.balance")," was reduced by 450M ROSE and transferred to the Common Pool to fund increased staking rewards."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"extra_data"),": This field can hold network's extra data, but is currently ignored everywhere. For this upgrade, we changed it back to the value in the Mainnet Beta genesis file to include the Oasis network's genesis quote: ",(0,i.kt)("em",{parentName:"li"},"\u201d"),(0,i.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Quis_custodiet_ipsos_custodes%3F"},(0,i.kt)("em",{parentName:"a"},"Quis custodiet ipsos custodes?")),(0,i.kt)("em",{parentName:"li"},"\u201d ","[","submitted by Oasis Community Member Daniyar Borangaziyev","]","."))),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The balances in the genesis file are enumerated in base units with 1 ROSE token equaling 10^9 (i.e. billion) base units. For more details, see the ",(0,i.kt)("a",{parentName:"p",href:"/general/oasis-network/genesis-doc#parameters"},"Genesis Document")," docs."))),(0,i.kt)("p",null,"If you obtain the same result, then you have successfully verified the provided genesis file."),(0,i.kt)("h2",{id:"stop-your-node"},"Stop Your Node"),(0,i.kt)("p",null,"This will depend on your process manager. You should stop your ",(0,i.kt)("a",{parentName:"p",href:"/general/run-a-node/prerequisites/oasis-node"},"Oasis Node")," process however this is done for your setup."),(0,i.kt)("h2",{id:"wipe-state"},"Wipe State"),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"We do not suggest that you wipe ",(0,i.kt)("em",{parentName:"p"},"all")," state. You might lose node identities and keys if you do it this way."))),(0,i.kt)("p",null,"Before restarting your node you should wipe consensus state. The process for this is described in the ",(0,i.kt)("a",{parentName:"p",href:"/general/run-a-node/maintenance-guides/wiping-node-state#state-wipe-and-keep-node-identity"},"Wiping Node State")," document."),(0,i.kt)("h2",{id:"update-configuration"},"Update Configuration"),(0,i.kt)("p",null,"If the ",(0,i.kt)("a",{parentName:"p",href:"/general/run-a-node/upgrade-log"},"Upgrade Log")," provides instructions for updating your node's configuration, update the ",(0,i.kt)("inlineCode",{parentName:"p"},"/serverdir/etc/config.yml")," file accordingly."),(0,i.kt)("h2",{id:"upgrade-oasis-node"},"Upgrade Oasis Node"),(0,i.kt)("p",null,"Before starting your node again, make sure you upgrade your ",(0,i.kt)("a",{parentName:"p",href:"/general/run-a-node/prerequisites/oasis-node"},"Oasis Node")," binary to the current version specified in the ",(0,i.kt)("a",{parentName:"p",href:"/general/oasis-network/network-parameters"},"Network Parameters"),"."),(0,i.kt)("h2",{id:"start-your-node"},"Start Your Node"),(0,i.kt)("p",null,"This will depend on your process manager. If you don't have a process manager, you should use one. However, to start the node without a process manager you can start the ",(0,i.kt)("a",{parentName:"p",href:"/general/run-a-node/prerequisites/oasis-node"},"Oasis Node")," like so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"oasis-node --config /serverdir/etc/config.yml\n")),(0,i.kt)("h2",{id:"clean-up"},"Clean Up"),(0,i.kt)("p",null,"After you're comfortable with your node deployment, you can clean up the ",(0,i.kt)("inlineCode",{parentName:"p"},"genesis_dump.json")," file."))}m.isMDXComponent=!0}}]);